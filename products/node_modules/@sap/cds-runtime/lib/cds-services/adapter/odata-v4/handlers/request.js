const measurePerformance = require('../../utils/performance')

const request = (req, res, next) => {
  /*
   * .on('request') is the only possibility to set a shared object,
   * that can be used in ATOMICITY_GROUP_START and ATOMICITY_GROUP_END
   */
  if (req.getUrlObject().path.includes('$batch')) {
    req.setApplicationData({
      req: req.getIncomingRequest()
    })
  }

  // in case of batch request with sap-statistics=true also measure performance of batched requests
  if (req.getBatchApplicationData()) {
    measurePerformance(req.getIncomingRequest(), res._response)
  }

  next()
}

module.exports = request
